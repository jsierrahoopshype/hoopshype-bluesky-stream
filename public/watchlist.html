<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bluesky Watchlist</title>
  <style>
    :root { --bg:#0b1220; --panel:#121a2a; --muted:#9fb0c9; --text:#e6eefb; --accent:#27c07d; --chip:#1a253b; --chip-on:#223251; --border:#24314a; }
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    h1{font-weight:600;font-size:18px;margin:0 0 10px}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .grid{display:grid;grid-template-columns:1fr 350px;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .row > *{min-height:36px}
    input[type="number"],input[type="text"],select{background:#0e1627;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:8px}
    input[type="checkbox"]{transform:translateY(1px)}
    button{background:var(--accent);color:#072114;border:0;border-radius:8px;padding:9px 14px;font-weight:600;cursor:pointer}
    button.secondary{background:#1f2b42;color:var(--text)}
    .chips{max-height:200px;overflow:auto;border:1px solid var(--border);border-radius:10px;padding:10px;margin-top:8px}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--border);color:var(--text);border-radius:999px;padding:6px 10px;margin:6px 6px 0 0;white-space:nowrap}
    .chip input{accent-color:var(--accent)}
    .muted{color:var(--muted)}
    .results{display:flex;flex-direction:column;gap:12px;margin-top:10px}
    .item{border:1px solid var(--border);border-radius:10px;padding:12px;background:#0f182b}
    .item .meta{font-size:12px;color:var(--muted);margin-bottom:6px;display:flex;gap:8px;flex-wrap:wrap}
    .item img{max-width:100%;border-radius:8px;margin-top:8px}
    .right-sticky{position:sticky;top:12px;height:calc(100dvh - 48px)}
    .right-sticky .card{height:100%;display:flex;flex-direction:column}
    .right-sticky .card textarea{flex:1;min-height:200px;background:#0e1627;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px;resize:vertical}
    .pill{display:inline-flex;background:#0f2434;border:1px solid var(--border);border-radius:999px;padding:4px 8px;font-size:12px;margin-right:6px}
    .spinner{display:none}
    .spinner.on{display:inline-block;inline-size:14px;block-size:14px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .error{color:#ff8b8b}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Bluesky Watchlist</h1>
    <div class="grid">
      <div class="card">
        <div class="row">
          <input id="q" type="text" placeholder="(optional filter in post text)" style="flex:1 1 320px">
          <label>Lookback (hours) <input id="hours" type="number" min="1" value="6" style="width:80px"></label>
          <label>Min reposts <input id="minReposts" type="number" min="0" value="0" style="width:70px"></label>
          <label>Min likes <input id="minLikes" type="number" min="0" value="0" style="width:70px"></label>
          <label>Limit (total) <input id="limit" type="number" min="1" value="60" style="width:80px"></label>
        </div>
        <div class="row" style="margin-top:8px">
          <select id="sort">
            <option value="desc">Recent (desc)</option>
            <option value="asc">Oldest (asc)</option>
            <option value="likes">Most likes</option>
            <option value="reposts">Most reposts</option>
          </select>
          <label><input id="incReplies" type="checkbox"> Include replies</label>
          <label><input id="nocache" type="checkbox"> nocache</label>
          <button id="searchBtn">Search <span id="spin" class="spinner"></span></button>
          <button id="allBtn" class="secondary">All</button>
          <button id="noneBtn" class="secondary">None</button>
          <span id="err" class="error" role="alert"></span>
        </div>

        <div class="muted" style="margin-top:10px">Accounts (from <code>reporters.csv</code>)</div>
        <div id="accountsBox" class="chips"></div>

        <div id="results" class="results"></div>
      </div>

      <div class="right-sticky">
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <div class="muted">Selected <span id="selCount">0</span></div>
            <label class="muted"><input id="priorityFirst" type="checkbox" checked> Priority first</label>
          </div>
          <div class="row" style="margin-top:8px">
            <button id="copyTxt">Copy plain text</button>
            <button id="copyCsv" class="secondary">Copy CSV</button>
            <button id="copyHtml" class="secondary">Copy publisher-safe HTML</button>
          </div>
          <div class="muted" style="margin-top:10px">Preview of copied output…</div>
          <textarea id="preview" spellcheck="false"></textarea>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Utility ----------
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const delay = ms => new Promise(r => setTimeout(r, ms));

    // ---------- Persistent enabled accounts (Blobs with localStorage fallback) ----------
    const ACCOUNTS_BLOB_KEY = 'watchlist-accounts';
    async function loadEnabledFromServer() {
      try {
        const res = await fetch('/api/watchlist-accounts');
        if (!res.ok) return null;
        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) return null;
        const json = await res.json();
        return Array.isArray(json.enabled) ? json.enabled : null;
      } catch { return null; }
    }
    async function saveEnabledToServer(enabled) {
      try {
        await fetch('/api/watchlist-accounts', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ enabled })
        });
      } catch {}
    }
    function loadEnabledLocal() {
      try {
        const x = localStorage.getItem(ACCOUNTS_BLOB_KEY);
        return x ? JSON.parse(x) : null;
      } catch { return null; }
    }
    function saveEnabledLocal(enabled) {
      try { localStorage.setItem(ACCOUNTS_BLOB_KEY, JSON.stringify(enabled)); } catch {}
    }

    // ---------- Reporters CSV ----------
    async function fetchReporters() {
      const res = await fetch('/reporters.csv?_=' + Date.now());
      const txt = await res.text();
      // CSV: handle,priority (optional priority=true)
      const lines = txt.trim().split(/\r?\n/).filter(Boolean);
      return lines.map((line) => {
        const [handleRaw, priRaw] = line.split(',').map(s => s.trim());
        const handle = handleRaw.startsWith('@') ? handleRaw : '@' + handleRaw;
        const priority = (priRaw || '').toLowerCase() === 'true';
        return { handle, priority };
      });
    }

    // ---------- Build account chips ----------
    async function buildAccountsUI() {
      const reporters = await fetchReporters();
      const box = $('#accountsBox');
      box.innerHTML = '';
      const enabledServer = await loadEnabledFromServer();
      const enabledLocal = loadEnabledLocal();
      let enabled = enabledServer || enabledLocal || reporters.map(r => r.handle); // default: all

      reporters.forEach((r, idx) => {
        const id = 'acc_' + idx;
        const chip = document.createElement('label');
        chip.className = 'chip';
        chip.innerHTML = `
          <input type="checkbox" id="${id}" data-handle="${r.handle}" ${enabled.includes(r.handle) ? 'checked' : ''}/>
          <span>${r.handle}</span>
          ${r.priority ? '<span class="pill">priority</span>' : ''}
        `;
        box.appendChild(chip);
      });

      // Persist selection on change
      box.addEventListener('change', () => {
        const list = $$('#accountsBox input[type="checkbox"]:checked').map(i => i.dataset.handle);
        saveEnabledLocal(list);
        saveEnabledToServer(list); // best effort
      });

      return reporters;
    }

    // ---------- Results selection & copy ----------
    function updateSelectedCounts() {
      const n = $$('#results input[type="checkbox"]:checked').length;
      $('#selCount').textContent = n;
    }
    function renderItems(items) {
      const results = $('#results');
      results.innerHTML = '';
      const frag = document.createDocumentFragment();

      items.forEach((it, i) => {
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `
          <label style="display:flex;gap:10px;align-items:start;">
            <input type="checkbox" data-idx="${i}" />
            <div style="flex:1">
              <div class="meta">
                <span>${it.authorDisplay || it.authorHandle || ''}</span>
                ${it.authorHandle ? `<span class="muted">${it.authorHandle}</span>` : ''}
                ${it.tsLocal ? `<span class="muted">${it.tsLocal}</span>` : ''}
                ${typeof it.likeCount === 'number' ? `<span class="muted">❤ ${it.likeCount}</span>` : ''}
                ${typeof it.repostCount === 'number' ? `<span class="muted">↻ ${it.repostCount}</span>` : ''}
              </div>
              <div>${it.html || it.text || ''}</div>
              ${it.mediaUrl ? `<img src="${it.mediaUrl}" loading="lazy">` : ''}
              ${it.url ? `<div class="muted" style="margin-top:6px"><a href="${it.url}" target="_blank" rel="noopener">Open on Bluesky</a></div>` : ''}
            </div>
          </label>
        `;
        frag.appendChild(el);
      });

      results.appendChild(frag);
      results.addEventListener('change', (e) => {
        if (e.target.matches('input[type="checkbox"]')) updateSelectedCounts();
      }, { once: true }); // attach once
      updateSelectedCounts();
    }

    function collectSelected(items) {
      const idxs = new Set($$('#results input[type="checkbox"]:checked').map(i => +i.dataset.idx));
      return items.filter((_, i) => idxs.has(i));
    }

    function copyPlain(selected) {
      const lines = selected.map(s => `• ${s.authorDisplay || s.authorHandle || ''} — ${s.text?.replace(/\s+/g, ' ').trim() || ''}\n${s.url || ''}`);
      const out = lines.join('\n\n');
      navigator.clipboard.writeText(out);
      $('#preview').value = out;
    }

    function toCSV(rows) {
      const esc = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
      const headers = ['authorDisplay','authorHandle','tsLocal','likeCount','repostCount','url','text'];
      const lines = [headers.map(esc).join(',')];
      rows.forEach(r => {
        lines.push([
          r.authorDisplay, r.authorHandle, r.tsLocal, r.likeCount, r.repostCount, r.url, (r.text || '').replace(/\s+/g,' ').trim()
        ].map(esc).join(','));
      });
      return lines.join('\n');
    }

    function copyCSV(selected) {
      const out = toCSV(selected);
      navigator.clipboard.writeText(out);
      $('#preview').value = out;
    }

    function copyHTML(selected) {
      // Simple publisher-safe list (no embeds)
      const html = selected.map(s => {
        const line1 = `<strong>${s.authorDisplay || s.authorHandle || ''}</strong> <span style="color:#667">${s.tsLocal || ''}</span>`;
        const text = (s.text || '').replace(/\n/g,'<br>');
        const link = s.url ? `<div><a href="${s.url}" target="_blank" rel="noopener">${s.url}</a></div>` : '';
        return `<p>${line1}<br>${text}${link}</p>`;
      }).join('\n');
      navigator.clipboard.writeText(html);
      $('#preview').value = html;
    }

    // ---------- Stream batching (fix for long URLs) ----------
    async function fetchStreamChunk(params) {
      // GET /api/stream with short query
      const usp = new URLSearchParams(params);
      const res = await fetch('/api/stream?' + usp.toString());
      const ct = res.headers.get('content-type') || '';
      if (!res.ok || !ct.includes('application/json')) {
        const text = await res.text();
        throw new Error(`Stream error (${res.status}): ${text.slice(0,200)}`);
      }
      return res.json();
    }

    async function runBatchedStream(allAuthors, { q, hours, minReposts, minLikes, includeReplies, includeQuotes, limit, sort, nocache, priorityFirst }) {
      // Chunk authors to keep URL short (about 20 handles per call is safe)
      const CHUNK = 20;
      const chunks = [];
      for (let i=0; i<allAuthors.length; i+=CHUNK) chunks.push(allAuthors.slice(i,i+CHUNK));

      const perChunkLimit = Math.max(10, Math.ceil((limit || 60) / chunks.length)); // rough split

      const reqs = chunks.map(chunk => fetchStreamChunk({
        q: q || '',
        hours: hours || 6,
        minReposts: minReposts || 0,
        minLikes: minLikes || 0,
        includeReplies: includeReplies ? 1 : 0,
        includeQuotes: includeQuotes ? 1 : 0,
        authors: chunk.join(','),
        limit: perChunkLimit,
        sort: sort || 'desc',
        nocache: nocache ? 1 : 0,
        priorityFirst: priorityFirst ? 1 : 0
      }));

      const results = await Promise.all(reqs);
      // Each response is assumed {items:[...]}
      const items = results.flatMap(r => Array.isArray(r.items) ? r.items : []);

      // De-dupe by url (or ts+handle fallback)
      const seen = new Set();
      const deduped = [];
      for (const it of items) {
        const key = it.url || `${it.ts}|${it.authorHandle}`;
        if (!seen.has(key)) { seen.add(key); deduped.push(it); }
      }

      // Sort
      const s = (sort || 'desc');
      if (s === 'likes') deduped.sort((a,b)=>(b.likeCount||0)-(a.likeCount||0));
      else if (s === 'reposts') deduped.sort((a,b)=>(b.repostCount||0)-(a.repostCount||0));
      else if (s === 'asc') deduped.sort((a,b)=> new Date(a.ts||a.tsLocal||0) - new Date(b.ts||b.tsLocal||0));
      else deduped.sort((a,b)=> new Date(b.ts||b.tsLocal||0) - new Date(a.ts||a.tsLocal||0));

      // Final slice
      return deduped.slice(0, limit || 60);
    }

    // ---------- Wire up UI ----------
    let currentItems = [];

    async function runSearch(reporters) {
      $('#err').textContent = '';
      $('#spin').classList.add('on');
      try {
        const q = $('#q').value.trim();
        const hours = +$('#hours').value || 6;
        const minReposts = +$('#minReposts').value || 0;
        const minLikes = +$('#minLikes').value || 0;
        const limit = +$('#limit').value || 60;
        const sort = $('#sort').value;
        const includeReplies = $('#incReplies').checked;
        const includeQuotes = false;
        const nocache = $('#nocache').checked;
        const priorityFirst = $('#priorityFirst').checked;

        const selectedAuthors = $$('#accountsBox input[type="checkbox"]:checked').map(i => i.dataset.handle);
        if (selectedAuthors.length === 0) {
          renderItems([]);
          currentItems = [];
          return;
        }

        // batch (fix long URL)
        const items = await runBatchedStream(selectedAuthors, {
          q, hours, minReposts, minLikes, includeReplies, includeQuotes, limit, sort, nocache, priorityFirst
        });

        currentItems = items;
        renderItems(items);
      } catch (e) {
        $('#err').textContent = e.message || 'Error';
        renderItems([]);
        currentItems = [];
      } finally {
        $('#spin').classList.remove('on');
      }
    }

    async function init() {
      const reporters = await buildAccountsUI();

      // buttons
      $('#allBtn').addEventListener('click', () => {
        $$('#accountsBox input[type="checkbox"]').forEach(i => i.checked = true);
        const list = $$('#accountsBox input[type="checkbox"]:checked').map(i => i.dataset.handle);
        saveEnabledLocal(list); saveEnabledToServer(list);
      });
      $('#noneBtn').addEventListener('click', () => {
        $$('#accountsBox input[type="checkbox"]').forEach(i => i.checked = false);
        saveEnabledLocal([]); saveEnabledToServer([]);
      });
      $('#searchBtn').addEventListener('click', () => runSearch(reporters));

      // copy
      $('#copyTxt').addEventListener('click', () => copyPlain(collectSelected(currentItems)));
      $('#copyCsv').addEventListener('click', () => copyCSV(collectSelected(currentItems)));
      $('#copyHtml').addEventListener('click', () => copyHTML(collectSelected(currentItems)));

      // Auto-run first search
      await delay(50); // allow first paint
      $('#searchBtn').click();
    }

    init();
  </script>
</body>
</html>
