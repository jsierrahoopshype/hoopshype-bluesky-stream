<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluesky Watchlist</title>
<style>
  :root { --bg:#fafafa; --fg:#111; --muted:#777; --border:#e5e5e5; --accent:#0a5; }
  body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#fff; color:var(--fg); margin:0; }
  header { padding:16px 20px; border-bottom:1px solid var(--border); background:var(--bg); }
  h1 { font-size:20px; margin:0; }
  main { padding:16px 20px; display:grid; gap:16px; grid-template-columns: 1fr 320px; }
  @media (max-width: 1000px){ main { grid-template-columns: 1fr; } }

  .panel { border:1px solid var(--border); border-radius:12px; padding:12px; background:#fff; }
  .controls { display:grid; gap:8px; grid-template-columns: repeat(6, minmax(0,1fr)); align-items:end; }
  .controls .wide { grid-column: span 2; }
  label { font-size:12px; color:var(--muted); }
  input, select, button, textarea { width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); font:inherit; }
  input[type="checkbox"]{ width:auto; }
  button { background:var(--accent); color:#fff; border:none; cursor:pointer; }
  button.muted { background:#eee; color:#333; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

  .accounts { display:flex; gap:8px; flex-wrap:wrap; max-height:120px; overflow:auto; border:1px solid var(--border); border-radius:10px; padding:8px; }
  .tag { border:1px solid var(--border); border-radius:999px; padding:4px 10px; font-size:12px; background:#fff; white-space:nowrap; }
  .tag input { vertical-align:middle; margin-right:6px; }

  .results { display:flex; flex-direction:column; gap:12px; }
  .card { border:1px solid var(--border); border-radius:12px; padding:12px; display:grid; gap:8px; grid-template-columns: 28px 1fr; }
  .meta { color:var(--muted); font-size:12px; }
  .text { line-height:1.45; }
  .text a { color:var(--accent); text-decoration:none; }
  .select-col { display:flex; align-items:start; padding-top:3px; }
  .empty { color:var(--muted); padding:20px; text-align:center; border:1px dashed var(--border); border-radius:10px; }

  .side { display:flex; flex-direction:column; gap:12px; }
  .side .btns { display:flex; gap:8px; flex-wrap:wrap; }
  textarea { width:100%; min-height:220px; }
</style>
</head>
<body>
  <header>
    <h1>Bluesky Watchlist</h1>
  </header>

  <main>
    <!-- LEFT: controls + results -->
    <section class="panel">
      <div class="controls">
        <div class="wide">
          <label>Search topic (optional)</label>
          <input id="q" placeholder="(optional filter in post text)" />
        </div>
        <div>
          <label>Lookback (hours)</label>
          <input id="hours" type="number" min="1" value="6" />
        </div>
        <div>
          <label>Min reposts</label>
          <input id="minReposts" type="number" min="0" value="0" />
        </div>
        <div>
          <label>Min likes</label>
          <input id="minLikes" type="number" min="0" value="0" />
        </div>
        <div>
          <label>Limit (total)</label>
          <input id="limit" type="number" min="1" max="200" value="60" />
        </div>
        <div>
          <label>Sort by</label>
          <select id="sort">
            <option value="recent">Recent (desc)</option>
            <option value="reposts">Reposts (desc)</option>
            <option value="likes">Likes (desc)</option>
            <option value="total">Likes+Reposts (desc)</option>
          </select>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <span class="row">
          <label class="row"><input type="checkbox" id="includeReplies" /> Include replies</label>
          <label class="row"><input type="checkbox" id="nocache" /> nocache</label>
        </span>
        <span class="row">
          <button id="btnSearch">Search</button>
          <button class="muted" id="btnAll">All</button>
          <button class="muted" id="btnNone">None</button>
        </span>
      </div>

      <div style="margin-top:8px">
        <label>Accounts (from reporters.csv)</label>
        <div id="accounts" class="accounts"></div>
      </div>

      <div class="results" id="results" style="margin-top:12px"></div>
    </section>

    <!-- RIGHT: selection & exports -->
    <aside class="side">
      <section class="panel">
        <div class="row" style="justify-content:space-between; align-items:center">
          <strong>Selected <span id="selCount">0</span></strong>
          <label class="row" title="Prioritize CSV list first in display">
            <input type="checkbox" id="prioFirst" checked /> Priority first
          </label>
        </div>
        <div class="btns" style="margin-top:8px">
          <button id="copyText">Copy plain text</button>
          <button class="muted" id="copyCsv">Copy CSV</button>
          <button class="muted" id="copyHtml">Copy publisher-safe HTML</button>
        </div>
        <textarea id="preview" placeholder="Preview of copied output..."></textarea>
      </section>
    </aside>
  </main>

<script>
const els = {
  q: byId('q'),
  hours: byId('hours'),
  minReposts: byId('minReposts'),
  minLikes: byId('minLikes'),
  limit: byId('limit'),
  sort: byId('sort'),
  includeReplies: byId('includeReplies'),
  nocache: byId('nocache'),
  btnSearch: byId('btnSearch'),
  btnAll: byId('btnAll'),
  btnNone: byId('btnNone'),
  accounts: byId('accounts'),
  results: byId('results'),
  selCount: byId('selCount'),
  prioFirst: byId('prioFirst'),
  copyText: byId('copyText'),
  copyCsv: byId('copyCsv'),
  copyHtml: byId('copyHtml'),
  preview: byId('preview'),
};

let ACCOUNTS = [];       // [{handle, name, priorityIndex}]
let RESULTS = [];        // API results
let SELECTED = new Set();// urls selected

// 1) Load reporters.csv
initAccounts();

async function initAccounts(){
  try {
    const r = await fetch('/reporters.csv?ts=' + Date.now());
    const csv = await r.text();
    const lines = csv.split(/\r?\n/).filter(Boolean);
    const hdr = lines.shift() || '';
    const cols = hdr.split(',').map(s => s.trim().toLowerCase());

    const data = [];
    lines.forEach((line, i) => {
      const parts = safeSplitCsv(line, cols.length);
      if (!parts.length) return;
      const obj = Object.fromEntries(parts.map((v, i) => [cols[i] || `c${i}`, v.trim()]));
      let handle = '';
      // heuristics: prefer a column that looks like a handle or url
      for (const k of Object.keys(obj)) {
        const v = obj[k];
        if (!v) continue;
        if (v.includes('@') && v.endsWith('.bsky.social')) handle = v.replace(/^@/, '');
        else if (v.includes('@') && !v.includes(' ')) handle = v.replace(/^@/,'');
        else if (/bsky\.app\/profile\//.test(v)) handle = v.split('/profile/')[1].split(/[/?#]/)[0];
      }
      if (!handle) return;
      const name = obj.name || obj.display || obj.author || handle;
      data.push({ handle, name, priorityIndex: data.length });
    });
    ACCOUNTS = data;
    renderAccounts();
  } catch (e) {
    console.error('load reporters.csv', e);
    ACCOUNTS = [];
    renderAccounts();
  }
}

function renderAccounts(){
  els.accounts.innerHTML = '';
  if (!ACCOUNTS.length) {
    els.accounts.innerHTML = `<div class="empty">reporters.csv not found or empty</div>`;
    return;
  }
  for (const a of ACCOUNTS) {
    const tag = document.createElement('label');
    tag.className = 'tag';
    tag.innerHTML = `<input type="checkbox" data-h="${a.handle}"/> @${a.handle}`;
    els.accounts.appendChild(tag);
  }
}

els.btnAll.onclick = () => els.accounts.querySelectorAll('input').forEach(i => i.checked = true);
els.btnNone.onclick = () => els.accounts.querySelectorAll('input').forEach(i => i.checked = false);

// 2) Search
els.btnSearch.onclick = runSearch;

async function runSearch(){
  const chosen = [...els.accounts.querySelectorAll('input:checked')].map(i => i.dataset.h);
  if (!chosen.length) {
    els.results.innerHTML = `<div class="empty">Select at least one account.</div>`;
    return;
  }

  const params = new URLSearchParams({
    handles: chosen.join(','),
    hours: els.hours.value || '6',
    minReposts: els.minReposts.value || '0',
    minLikes: els.minLikes.value || '0',
    limit: els.limit.value || '60',
    sort: els.sort.value || 'recent',
    includeReplies: els.includeReplies.checked ? '1' : '0'
  });
  if (els.nocache.checked) params.set('nocache', '1');

  els.results.innerHTML = `<div class="empty">Loading‚Ä¶</div>`;
  SELECTED.clear(); updateSelCount();

  try {
    const r = await fetch(`/api/watchlist?${params.toString()}`);
    const j = await r.json();
    if (!j.items || !j.items.length) {
      els.results.innerHTML = `<div class="empty">No results for those filters.</div>`;
      RESULTS = [];
      return;
    }

    // optional client-side text filter
    const q = (els.q.value || '').trim().toLowerCase();
    let items = j.items;
    if (q) items = items.filter(p => p.text.toLowerCase().includes(q));

    // priority-first reorder (CSV order first) if enabled
    if (els.prioFirst.checked) {
      const rank = new Map(ACCOUNTS.map((a,i) => [a.handle.toLowerCase(), i]));
      items.sort((a,b) => {
        const ra = rank.get(a.authorHandle.toLowerCase()) ?? 9999;
        const rb = rank.get(b.authorHandle.toLowerCase()) ?? 9999;
        if (ra !== rb) return ra - rb;
        return b.ts - a.ts;
      });
    }

    RESULTS = items;
    renderResults();
  } catch (e) {
    console.error(e);
    els.results.innerHTML = `<div class="empty">Error: ${e.message || e}</div>`;
  }
}

function renderResults(){
  if (!RESULTS.length) {
    els.results.innerHTML = `<div class="empty">No matches.</div>`;
    return;
  }
  els.results.innerHTML = '';
  for (const p of RESULTS) {
    const id = p.url; // unique enough
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="select-col"><input type="checkbox" data-id="${id}"></div>
      <div>
        <div class="meta">
          <strong>${esc(p.authorDisplay)}</strong> (@${esc(p.authorHandle)}) ¬∑
          <time>${esc(p.tsLocal)}</time> ¬∑
          ‚ù§ ${p.likeCount} ¬∑ üîÅ ${p.repostCount} ¬∑
          <a href="${p.url}" target="_blank" rel="ugc nofollow noopener">Open</a>
        </div>
        <div class="text">${linkify(esc(p.text)).replace(/\n/g,'<br>')}</div>
      </div>`;
    els.results.appendChild(card);
    card.querySelector('input').onchange = (e) => {
      if (e.target.checked) SELECTED.add(id); else SELECTED.delete(id);
      updateSelCount();
      buildPreview();
    };
  }
}

function updateSelCount(){ els.selCount.textContent = String(SELECTED.size); }

// 3) Export buttons
els.copyText.onclick = () => copy(buildPlainText());
els.copyCsv.onclick  = () => copy(buildCsv());
els.copyHtml.onclick = () => copy(buildHtml());

function buildPlainText(){
  const rows = [];
  for (const p of RESULTS) {
    if (!SELECTED.has(p.url)) continue;
    rows.push(`${p.authorDisplay} (@${p.authorHandle}) ‚Äî ${p.tsLocal}
${p.text}

${p.url}
‚Äî ‚Äî ‚Äî`);
  }
  const out = rows.join('\n');
  els.preview.value = out;
  return out;
}

function buildCsv(){
  const rows = [['author','handle','timestamp','likes','reposts','url','text']];
  for (const p of RESULTS) {
    if (!SELECTED.has(p.url)) continue;
    rows.push([p.authorDisplay, p.authorHandle, p.tsLocal, p.likeCount, p.repostCount, p.url, p.text.replace(/\n/g,' ')]);
  }
  const out = rows.map(r => r.map(csvEscape).join(',')).join('\n');
  els.preview.value = out;
  return out;
}

function buildHtml(){
  const blocks = [];
  for (const p of RESULTS) {
    if (!SELECTED.has(p.url)) continue;
    const excerpt = esc(p.text).slice(0, 200);
    blocks.push(`<article class="hh-reaction">
<header class="hh-reaction-hd"><a href="https://bsky.app/profile/${enc(p.authorHandle)}" rel="ugc nofollow noopener" target="_blank">${esc(p.authorDisplay)} (@${esc(p.authorHandle)})</a> ¬∑ <time>${esc(p.tsLocal)}</time></header>
<blockquote>${esc(excerpt)}‚Ä¶ <a href="${p.url}" rel="ugc nofollow noopener" target="_blank">Open on Bluesky</a></blockquote>
</article>`);
  }
  const out = `<section class="hh-reactions" aria-label="Bluesky reactions">
${blocks.join('\n')}
</section>`;
  els.preview.value = out;
  return out;
}

function buildPreview(){ els.preview.value = buildPlainText(); }

function copy(text){
  navigator.clipboard.writeText(text).then(()=>{},()=>{});
}

// utils
function byId(id){ return document.getElementById(id); }
function esc(s){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m])); }
function enc(s){ return encodeURIComponent(s); }
function linkify(s){
  return s.replace(/(https?:\/\/[^\s]+)/g, (m)=>`<a href="${m}" target="_blank" rel="ugc nofollow noopener">${m}</a>`);
}
function csvEscape(s){ s = String(s ?? ''); if (/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"'; return s; }

// naive CSV split that respects simple quoted fields
function safeSplitCsv(line, want){
  const out = [];
  let cur = '';
  let inQ = false;
  for (let i=0;i<line.length;i++){
    const c = line[i];
    if (c === '"'){
      if (inQ && line[i+1] === '"'){ cur += '"'; i++; }
      else inQ = !inQ;
    } else if (c === ',' && !inQ){ out.push(cur); cur=''; }
    else cur += c;
  }
  out.push(cur);
  while (out.length < want) out.push('');
  return out;
}
</script>
</body>
</html>
