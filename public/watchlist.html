<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluesky Watchlist</title>
<style>
  :root{
    --bg:#fff;
    --fg:#111;
    --muted:#666;
    --line:#e7e7ea;
    --pill:#eef2ff;
    --pill-text:#253bff;
    --brand:#1967ff;
    --card:#fafafa;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";}
  .wrap{max-width:1200px;margin:0 auto;padding:18px;}
  h1{font-size:20px;margin:0 0 14px 0}
  .grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
  @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  .panel{border:1px solid var(--line);border-radius:10px;background:#fff}
  .panel > .head{padding:14px 14px 0 14px}
  .panel > .body{padding:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .row > *{margin:6px 0}
  input[type="text"],input[type="number"],select{height:34px;border:1px solid var(--line);border-radius:8px;padding:6px 10px;background:#fff;color:var(--fg)}
  input[type="number"]{width:100px}
  .grow{flex:1}
  .btn{background:#f4f6ff;border:1px solid #cdd6ff;color:#1136ff;border-radius:8px;height:36px;padding:0 12px;cursor:pointer}
  .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .muted{color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#fff}
  .chip input{transform:translateY(1px)}
  .chip a{color:var(--fg);text-decoration:none}
  .chip .pill{background:var(--pill);color:var(--pill-text);padding:2px 6px;border-radius:999px;font-size:12px}
  .items{display:flex;flex-direction:column;gap:12px}
  .card{border:1px solid var(--line);border-radius:10px;background:var(--card);padding:12px}
  .card .top{display:flex;gap:8px;align-items:center;margin-bottom:6px}
  .avatar{width:28px;height:28px;border-radius:50%;background:#ddd;flex:0 0 28px}
  .author{font-weight:600}
  .handle{color:var(--muted)}
  .pills{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
  .pill-btn{display:inline-block;background:#eef7ff;color:#0b60c5;border:1px solid #cde7ff;border-radius:999px;padding:2px 8px;font-size:12px;text-decoration:none}
  .thumb{margin-top:8px;max-width:100%;border-radius:8px;border:1px solid var(--line)}
  .side .head{display:flex;justify-content:space-between;align-items:center}
  .copy-box{min-height:300px;border:1px solid var(--line);border-radius:8px;padding:10px;white-space:pre-wrap;background:#fff}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap}
  .status{margin-left:8px}
</style>
</head>
<body>
<div class="wrap">
  <h1>Bluesky Watchlist</h1>
  <div class="grid">
    <div class="panel">
      <div class="head">
        <div class="row">
          <input id="q" class="grow" type="text" placeholder="(optional) filter in post text">
          <label>Lookback (h) <input id="hours" type="number" value="24" min="1" max="168"></label>
          <label>Min reposts <input id="minReposts" type="number" value="0" min="0"></label>
          <label>Min likes <input id="minLikes" type="number" value="0" min="0"></label>
          <label>Limit <input id="limit" type="number" value="150" min="1" max="500"></label>
        </div>
        <div class="row">
          <label><input id="inclReplies" type="checkbox"> Include replies</label>
          <label><input id="inclQuotes" type="checkbox" checked> Include quotes</label>
          <label><input id="exclReposts" type="checkbox" checked> Exclude reposts</label>
          <label><input id="nocache" type="checkbox"> nocache</label>
          <button id="btnSearch" class="btn primary">Search</button>
          <span id="status" class="muted status"></span>
        </div>
      </div>
      <div class="body">
        <div class="row">
          <button id="btnAll" class="btn">All</button>
          <button id="btnNone" class="btn">None</button>
        </div>
        <div id="accountsBox" class="chips" style="margin-top:8px"></div>
      </div>
      <div class="body">
        <div id="results" class="items"></div>
      </div>
    </div>

    <div class="panel side">
      <div class="head">
        <div class="toolbar">
          <button id="copyTxt" class="btn primary">Copy plain text</button>
          <button id="copyCsv" class="btn">Copy CSV</button>
          <button id="copyHtml" class="btn">Copy publisher-safe HTML</button>
        </div>
      </div>
      <div class="body">
        <div class="muted" style="margin:4px 0 8px 0">Preview of copied output…</div>
        <div id="preview" class="copy-box"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- tiny helpers ---------- */
const $  = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
const prof = h => `https://bsky.app/profile/${h.replace(/^@/,'')}`;
const utm  = u => u + (u.includes('?') ? '&' : '?') + 'utm_source=hoopshype';
const isVideoLink = u => /(youtube\.com|youtu\.be|vimeo\.com|tiktok\.com|instagram\.com|x\.com|twitter\.com|clips?|video)/i.test(u);

/* ---------- persistence (server optional, local fallback) ---------- */
const LS_KEY = 'watchlist.enabled';

async function loadBlobRaw(){
  try{
    const r = await fetch('/api/watchlist-accounts');
    if(!r.ok) return null;
    return await r.json();
  }catch{ return null }
}
async function saveBlob(enabled){
  try{
    await fetch('/api/watchlist-accounts',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({enabled})});
  }catch{}
}
function loadLocal(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY)||'[]') }catch{ return [] }
}
function saveLocal(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr||[]));
}

/* ---------- CSV loading & smart handle extraction ---------- */
async function fetchReporters(){
  const text = await fetch('/reporters.csv',{cache:'no-store'}).then(r=>r.text());
  const rows = parseCSV(text);
  const handles = extractHandlesFromRows(rows);
  // Create objects {handle}
  return handles.map(h => ({ handle: h }));
}

// tolerant CSV parser
function parseCSV(text){
  const out = [];
  let row = [], cell = '', q = false;
  for(let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if(q){
      if(c === '"' && n === '"'){ cell += '"'; i++; continue; }
      if(c === '"'){ q = false; continue; }
      cell += c; continue;
    }
    if(c === '"'){ q = true; continue; }
    if(c === ','){ row.push(cell); cell=''; continue; }
    if(c === '\n' || c === '\r'){
      if(cell.length || row.length) { row.push(cell); out.push(row); row=[]; cell=''; }
      if(c === '\r' && n === '\n') i++;
      continue;
    }
    cell += c;
  }
  if(cell.length || row.length){ row.push(cell); out.push(row); }
  return out.filter(r => r.some(v => String(v).trim().length));
}

// NEW: robust scanner for real Bluesky handles (must include a dot)
function extractHandlesFromRows(rows){
  const handles = new Set();

  // 1) scan all cells for @xxx.yyy
  for(const row of rows){
    for(let cell of row){
      cell = String(cell||'');
      const matches = cell.match(/@[\w.-]+(?:\.[\w.-]+)+/g);
      if(matches) matches.forEach(h => handles.add(h.trim()));
    }
  }
  if(handles.size) return Array.from(handles);

  // 2) header fallback if there is a "handle" style column
  const header = rows[0]?.map(h => String(h).trim().toLowerCase()) || [];
  const idx = ['handle','author','username'].map(k => header.indexOf(k)).find(i => i >= 0);
  if(idx >= 0){
    const out=[];
    rows.slice(1).forEach(r=>{
      const raw = (r[idx]||'').trim();
      const m = raw.match(/@[\w.-]+(?:\.[\w.-]+)+/);
      if(m) out.push(m[0]);
    });
    if(out.length) return Array.from(new Set(out));
  }

  // 3) last fallback: first @token with dot per cell
  for(const row of rows){
    for(let cell of row){
      const m = String(cell||'').match(/@[\w.-]+(?:\.[\w.-]+)+/);
      if(m) handles.add(m[0]);
    }
  }
  return Array.from(handles);
}

/* ---------- build UI for accounts ---------- */
async function buildAccountsUI(){
  const reporters = await fetchReporters();
  const allHandles = reporters.map(r => r.handle);

  const box = $('#accountsBox');
  box.innerHTML = '';

  // persisted selections
  const server = await loadBlobRaw();
  const serverEnabled = server && Array.isArray(server.enabled) ? server.enabled : null;
  const localEnabled  = loadLocal();
  const firstTime = (!serverEnabled || !serverEnabled.length) && (!localEnabled || !localEnabled.length);
  const enabled = firstTime ? allHandles : (serverEnabled && serverEnabled.length ? serverEnabled : localEnabled);

  reporters.forEach((r,i)=>{
    const id = 'acc_' + i;
    const checked = firstTime || enabled.includes(r.handle);
    const el = document.createElement('label');
    el.className = 'chip';
    el.innerHTML = `
      <input type="checkbox" id="${id}" data-handle="${r.handle}" ${checked?'checked':''}>
      <a href="${prof(r.handle)}" target="_blank" rel="noopener">${r.handle}</a>`;
    box.appendChild(el);
  });

  // persist on change
  box.addEventListener('change', ()=>{
    const list = $$('#accountsBox input[type="checkbox"]:checked').map(i=>i.dataset.handle);
    saveLocal(list);
    saveBlob(list);
  });

  // save ALL on first run so it sticks
  if(firstTime){ saveLocal(allHandles); saveBlob(allHandles); }

  return reporters;
}

/* ---------- query + render ---------- */
function selectedHandles(){
  return $$('#accountsBox input[type="checkbox"]:checked').map(i => i.dataset.handle);
}

function uiParams(){
  return {
    q: $('#q').value.trim(),
    hours: +$('#hours').value || 6,
    minReposts: +$('#minReposts').value || 0,
    minLikes: +$('#minLikes').value || 0,
    limit: +$('#limit').value || 150,
    includeReplies: $('#inclReplies').checked ? 1 : 0,
    includeQuotes: $('#inclQuotes').checked ? 1 : 0,
    excludeReposts: $('#exclReposts').checked ? 1 : 0,
    nocache: $('#nocache').checked ? 1 : 0
  };
}

function buildQuery(params, handles){
  const p = new URLSearchParams(params);
  if(handles.length) p.set('handles', handles.join(','));
  return '/api/stream?' + p.toString();
}

function pill(href, label){
  const a = document.createElement('a');
  a.href = href; a.target = '_blank'; a.rel = 'noopener';
  a.className = 'pill-btn'; a.textContent = label;
  return a;
}

function linkify(text){
  return text.replace(
    /(https?:\/\/[^\s)]+)(\)?)/g,
    (m,u,trail='') => `<a href="${u}" target="_blank" rel="noopener">${u}</a>${trail}`
  );
}

function render(items){
  const box = $('#results'); box.innerHTML = '';
  const previewLines = [];

  items.forEach(it=>{
    const card = document.createElement('div');
    card.className = 'card';

    const top = document.createElement('div');
    top.className = 'top';

    const av = document.createElement('img');
    av.className = 'avatar';
    av.src = it.authorAvatar || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    av.alt = '';
    top.appendChild(av);

    const who = document.createElement('div');
    who.innerHTML = `
      <div class="author"><a href="${prof(it.authorHandle||'')}" target="_blank" rel="noopener">${it.authorDisplay || it.authorHandle || '—'}</a></div>
      <div class="handle muted">${it.authorHandle||''}</div>`;
    top.appendChild(who);

    card.appendChild(top);

    const text = document.createElement('div');
    text.innerHTML = linkify( (it.text||'').trim() );
    card.appendChild(text);

    // pills
    const pills = document.createElement('div');
    pills.className = 'pills';
    if(it.url) pills.appendChild(pill(it.url, 'Open on Bluesky'));
    // always expose media/video links if we can
    const urls = getAllUrls(it.text||'').filter(isVideoLink);
    if(urls.length){
      urls.slice(0,3).forEach(u => pills.appendChild(pill(u, 'Video')));
    }
    if(pills.childNodes.length) card.appendChild(pills);

    // try thumbnail
    if(it.mediaUrl){
      const img = document.createElement('img');
      img.className = 'thumb';
      img.loading = 'lazy';
      img.src = it.mediaUrl;
      img.alt = '';
      card.appendChild(img);
    }

    box.appendChild(card);

    // copy/plain text line (requested format)
    const name = (it.authorDisplay || it.authorHandle || '').trim();
    const body = (it.text||'').trim().replace(/\s+\n/g,'\n');
    const url = it.url ? utm(it.url) : '';
    const one = `${name}: ${body}\n\n${url}`.trim();
    previewLines.push(one);
  });

  $('#preview').textContent = previewLines.join('\n\n');
}

function getAllUrls(s){
  const out = [];
  const r = /(https?:\/\/[^\s)]+)(\)?)/g; let m;
  while((m = r.exec(s))) out.push(m[1]);
  return out;
}

async function runSearch(auto=false){
  const handles = selectedHandles();
  const params = uiParams();

  if(!handles.length){
    $('#status').textContent = 'Select at least one account';
    return;
  }

  $('#btnSearch').disabled = true;
  $('#status').textContent = 'Loading…';

  try{
    const url = buildQuery(params, handles);
    const r = await fetch(url, {cache: 'no-store'});
    if(!r.ok){
      const text = await r.text();
      throw new Error(`API ${r.status} ${r.statusText}: ${text.slice(0,120)}`);
    }
    const {items=[]} = await r.json(); // expected shape from your /api/stream
    // filter reposts client-side too as safety
    const filtered = params.excludeReposts ? items.filter(it => !it.isRepost) : items;
    render(filtered);
    $('#status').textContent = `${filtered.length} results`;
  }catch(err){
    $('#status').textContent = 'Error';
    const msg = String(err.message||err);
    const box = $('#results'); box.innerHTML =
      `<div class="card"><div class="muted">Error: ${escapeHtml(msg)}</div></div>`;
  }finally{
    $('#btnSearch').disabled = false;
  }
}

function escapeHtml(s){return s.replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]))}

/* ---------- copy buttons ---------- */
function collectForCopy(){
  return $('#preview').textContent.trim();
}
$('#copyTxt').addEventListener('click', async ()=>{
  const s = collectForCopy();
  await navigator.clipboard.writeText(s);
  flash('Copied plain text');
});
$('#copyCsv').addEventListener('click', async ()=>{
  const lines = $('#preview').textContent.trim().split('\n\n').map(b=>{
    const [first,...rest] = b.split('\n');
    const url = rest.at(-1)||'';
    const text = rest.slice(0,-1).join(' ').trim();
    const m = first.match(/^([^:]+):\s*(.*)$/);
    const name = m ? m[1] : '';
    const body = m ? m[2] : first;
    return `"${name.replace(/"/g,'""')}","${(body + (text?' '+text:'' )).replace(/"/g,'""')}","${url}"`;
  });
  const csv = 'name,text,url\n' + lines.join('\n');
  await navigator.clipboard.writeText(csv);
  flash('CSV copied');
});
$('#copyHtml').addEventListener('click', async ()=>{
  const blocks = $('#preview').textContent.trim().split('\n\n').map(b=>{
    const [first,...rest] = b.split('\n');
    const url = rest.at(-1)||'';
    const body = rest.slice(0,-1).join(' ').trim();
    const m = first.match(/^([^:]+):\s*(.*)$/);
    const name = m ? m[1] : first;
    const text = m ? m[2] : body;
    return `<p><strong>${escapeHtml(name)}:</strong> ${escapeHtml(text)}</p><p><a href="${escapeHtml(url)}">${escapeHtml(url)}</a></p>`;
  });
  const html = blocks.join('\n');
  await navigator.clipboard.writeText(html);
  flash('HTML copied');
});

function flash(msg){
  const s = $('#status');
  const old = s.textContent;
  s.textContent = msg;
  setTimeout(()=>s.textContent = old, 1500);
}

/* ---------- buttons & boot ---------- */
$('#btnAll').addEventListener('click', ()=>{
  $$('#accountsBox input[type="checkbox"]').forEach(i=>i.checked=true);
  const list = $$('#accountsBox input[type="checkbox"]:checked').map(i=>i.dataset.handle);
  saveLocal(list); saveBlob(list);
});
$('#btnNone').addEventListener('click', ()=>{
  $$('#accountsBox input[type="checkbox"]').forEach(i=>i.checked=false);
  saveLocal([]); saveBlob([]);
});
$('#btnSearch').addEventListener('click', ()=>runSearch(false));

(async function init(){
  await buildAccountsUI();
  // auto-run on first load, always
  runSearch(true);
})();
</script>
</body>
</html>
