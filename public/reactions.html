<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bluesky Reactions Builder</title>
<style>
  :root { --accent:#1d6ee3; --muted:#666; --line:#e6e6e6; --bg:#f7f7f9; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; background:#fff; color:#111; }
  header { padding:16px 18px; border-bottom:1px solid var(--line); position:sticky; top:0; background:#fff; z-index:5; }
  h1 { font-size:18px; margin:0 0 10px; }
  .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
  label { font-size:12px; color:var(--muted); }
  input[type="text"], input[type="number"], select { padding:8px 10px; border:1px solid #cfd3d8; border-radius:6px; font: inherit; }
  .btn { background:var(--accent); color:#fff; border:0; border-radius:6px; padding:8px 12px; cursor:pointer; font-weight:600 }
  .btn:disabled{ opacity:.5; cursor:not-allowed; }
  main { display:grid; grid-template-columns: minmax(320px, 1fr) 380px; gap:16px; padding:16px; }
  .results { display:flex; flex-direction:column; gap:12px; min-height:200px; }
  .card { border:1px solid var(--line); border-radius:10px; padding:12px; background:#fff; display:grid; grid-template-columns: auto 1fr; gap:10px; }
  .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; background:#eee; }
  .meta { font-size:12px; color:var(--muted) }
  .name { font-weight:700; color:#111; margin-right:6px; }
  .handle { color:var(--muted); }
  .prio { display:inline-block; background:#fff4d6; color:#7a5300; border:1px solid #f5d36b; padding:1px 6px; border-radius:999px; font-size:11px; margin-left:6px }
  .text { font-size:14px; line-height:1.35; margin:8px 0; }
  .img { margin-top:6px; }
  .img img { max-width:100%; border-radius:8px; display:block }
  .footer { margin-top:6px; font-size:12px }
  .footer a { text-decoration:none; color:#555 }
  .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
  .pill { font-size:12px; padding:5px 8px; background:#f0f2f5; border-radius:999px; color:#333; border:1px solid #e2e6eb;}
  aside { position:sticky; top:76px; align-self:start; border:1px solid var(--line); border-radius:10px; background:#fff; }
  .sel-head { display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid var(--line); }
  .sel-list { max-height:60vh; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:8px; }
  .sel-item { display:flex; gap:8px; align-items:center; border:1px dashed #d8dbe1; border-radius:8px; padding:8px; background:#fafbfc; cursor:grab }
  .sel-item .drag { font-size:18px; color:#aaa; cursor:grab }
  .sel-actions { padding:10px; border-top:1px solid var(--line); display:flex; gap:8px; flex-wrap:wrap; }
  .muted { color:var(--muted); font-size:12px; }
  .row2 { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .chk { display:inline-flex; align-items:center; gap:6px; font-size:12px; }
</style>
</head>
<body>
<header>
  <h1>Bluesky Reactions Builder</h1>
  <div class="row">
    <input id="q" type="text" placeholder="Search (e.g., Luka Doncic trade)" value="NBA" style="min-width:280px">
    <label>Lookback (hours) <input id="hours" type="number" value="6" min="1" max="48" style="width:80px"></label>
    <label>Min reposts <input id="minReposts" type="number" value="1" min="0" style="width:80px"></label>
    <label>Min likes <input id="minLikes" type="number" value="0" min="0" style="width:80px"></label>
    <label>Limit <input id="limit" type="number" value="40" min="1" max="100" style="width:80px"></label>
    <label>Sort
      <select id="sort">
        <option value="reposts">Reposts (desc)</option>
        <option value="likes">Likes (desc)</option>
        <option value="engagement">Engagement (likes+reposts)</option>
      </select>
    </label>
    <button class="btn" id="btnSearch">Search</button>
    <div class="row2">
      <label class="chk"><input id="inclReplies" type="checkbox"> Include replies</label>
      <label class="chk"><input id="inclQuotes" type="checkbox"> Include quotes</label>
      <label class="chk"><input id="preferReporters" type="checkbox" checked> Show priority first</label>
      <label class="chk"><input id="nocache" type="checkbox"> nocache</label>
    </div>
  </div>
</header>

<main>
  <section>
    <div class="toolbar" id="pills"></div>
    <div id="results" class="results"></div>
  </section>

  <aside>
    <div class="sel-head">
      <strong>Selected (<span id="selCount">0</span>)</strong>
      <label class="chk"><input id="priorityOnly" type="checkbox"> Priority only</label>
    </div>
    <div id="selList" class="sel-list"></div>
    <div class="sel-actions">
      <button class="btn" id="copyHtml">Copy Presto HTML</button>
      <button class="btn" id="copyLinks" style="background:#4b5563">Copy links only</button>
      <span class="muted">Drag to reorder before copying.</span>
    </div>
  </aside>
</main>

<script>
const els = {
  q: document.getElementById('q'),
  hours: document.getElementById('hours'),
  minReposts: document.getElementById('minReposts'),
  minLikes: document.getElementById('minLikes'),
  limit: document.getElementById('limit'),
  sort: document.getElementById('sort'),
  inclReplies: document.getElementById('inclReplies'),
  inclQuotes: document.getElementById('inclQuotes'),
  preferReporters: document.getElementById('preferReporters'),
  nocache: document.getElementById('nocache'),
  btnSearch: document.getElementById('btnSearch'),
  results: document.getElementById('results'),
  pills: document.getElementById('pills'),
  selList: document.getElementById('selList'),
  selCount: document.getElementById('selCount'),
  copyHtml: document.getElementById('copyHtml'),
  copyLinks: document.getElementById('copyLinks'),
  priorityOnly: document.getElementById('priorityOnly'),
};

let latest = [];
let selected = []; // array of post objects

function pill(txt){ const s=document.createElement('span'); s.className='pill'; s.textContent=txt; return s; }

function renderPills(params, count) {
  els.pills.innerHTML = '';
  els.pills.append(pill(`q: ${params.q || '—'}`));
  els.pills.append(pill(`window: ${params.hours}h`));
  els.pills.append(pill(`min reposts: ${params.minReposts}`));
  els.pills.append(pill(`${count} result${count===1?'':'s'}`));
  const tip=document.createElement('div');
  tip.className='muted';
  tip.style.marginLeft='auto';
  tip.textContent="Tip: if results look low, include quotes, drop min reposts, or expand hours.";
  els.pills.append(tip);
}

function cardHTML(p, idx) {
  const prio = p.priority ? `<span class="prio">Priority</span>` : '';
  return `
    <article class="card" data-idx="${idx}">
      <input type="checkbox" class="pick" ${ selected.some(s=>s.url===p.url) ? 'checked':'' } />
      <img class="avatar" src="${p.authorAvatar||''}" alt="">
      <div>
        <div class="meta">
          <span class="name">${p.authorDisplay||''}</span>
          <span class="handle">@${p.authorHandle||''}</span>
          ${prio}
          <span> • ${p.tsLocal||''}</span>
          <span style="float:right;color:#444">♥ ${p.likeCount||0} ↻ ${p.repostCount||0}</span>
        </div>
        <div class="text">${p.html||''}</div>
        ${p.mediaUrl ? `<div class="img"><img loading="lazy" src="${p.mediaUrl}" alt=""></div>` : ``}
        <div class="footer"><a href="${p.url}" target="_blank" rel="noopener">Open on Bluesky</a></div>
      </div>
    </article>
  `;
}

function renderResults(list) {
  els.results.innerHTML = list.map((p,i)=>cardHTML(p,i)).join('');
  // attach handlers
  els.results.querySelectorAll('.pick').forEach((cb, i) => {
    const article = cb.closest('.card');
    const idx = Number(article.dataset.idx);
    cb.addEventListener('change', () => {
      const post = latest[idx];
      if (cb.checked) {
        if (!selected.some(s=>s.url===post.url)) selected.push(post);
      } else {
        selected = selected.filter(s=>s.url!==post.url);
      }
      renderSelection();
    });
  });
}

function renderSelection() {
  const onlyPrio = els.priorityOnly.checked;
  const show = onlyPrio ? selected.filter(x=>x.priority) : selected.slice();
  els.selCount.textContent = show.length;
  els.selList.innerHTML = show.map((p,i)=>`
    <div class="sel-item" draggable="true" data-url="${p.url}">
      <span class="drag">⋮⋮</span>
      <img class="avatar" src="${p.authorAvatar||''}" alt="">
      <div style="min-width:0">
        <div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
          <strong>${p.authorDisplay||''}</strong> @${p.authorHandle||''} ${p.priority?'<span class="prio">Priority</span>':''}
        </div>
        <div class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${p.text||''}</div>
      </div>
      <a href="${p.url}" target="_blank" class="muted" style="margin-left:auto;text-decoration:none">Open</a>
    </div>
  `).join('');

  // drag reorder
  els.selList.querySelectorAll('.sel-item').forEach(el=>{
    el.addEventListener('dragstart', e=>{
      e.dataTransfer.setData('text/url', el.dataset.url);
      el.classList.add('dragging');
    });
    el.addEventListener('dragend', ()=>{
      el.classList.remove('dragging');
    });
    el.addEventListener('dragover', e=>{
      e.preventDefault();
      const dragging = els.selList.querySelector('.dragging');
      if (!dragging) return;
      const rect = el.getBoundingClientRect();
      const after = (e.clientY - rect.top) > rect.height/2;
      els.selList.insertBefore(dragging, after ? el.nextSibling : el);
    });
  });
}

function selectionInCurrentOrder() {
  const urls = Array.from(els.selList.querySelectorAll('.sel-item')).map(n=>n.dataset.url);
  const byUrl = new Map(selected.map(s=>[s.url, s]));
  return urls.map(u=>byUrl.get(u)).filter(Boolean);
}

function buildPrestoHTML() {
  const items = selectionInCurrentOrder();
  if (!items.length) return '';
  // self-contained static HTML block (no scripts)
  return `
<div class="bsky-curated" style="font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif">
  ${items.map(p=>`
  <article style="border:1px solid #e5e7eb;border-radius:10px;padding:12px;margin:12px 0">
    <div style="display:flex;gap:10px;align-items:center">
      <img src="${p.authorAvatar||''}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;background:#eee">
      <div style="font-size:13px;color:#555">
        <strong style="color:#111">${p.authorDisplay||''}</strong>
        <span>@${p.authorHandle||''}</span>
        ${p.priority?'<span style="display:inline-block;background:#fff4d6;color:#7a5300;border:1px solid #f5d36b;padding:1px 6px;border-radius:999px;margin-left:6px;font-size:11px">Priority</span>':''}
        <span> • ${p.tsLocal||''}</span>
      </div>
      <div style="margin-left:auto;font-size:12px;color:#444">♥ ${p.likeCount||0} ↻ ${p.repostCount||0}</div>
    </div>
    <div style="font-size:15px;line-height:1.4;margin:8px 0">${p.html||''}</div>
    ${p.mediaUrl?`<div><img src="${p.mediaUrl}" style="max-width:100%;height:auto;border-radius:8px;display:block"></div>`:''}
    <div style="margin-top:6px;font-size:12px"><a href="${p.url}" target="_blank" rel="noopener" style="text-decoration:none;color:#2563eb">Open on Bluesky</a></div>
  </article>`).join('')}
</div>`.trim();
}

async function copy(text) {
  await navigator.clipboard.writeText(text);
  alert('Copied!');
}

async function runSearch() {
  const params = {
    q: els.q.value.trim(),
    hours: Number(els.hours.value || 6),
    minReposts: Number(els.minReposts.value || 0),
    minLikes: Number(els.minLikes.value || 0),
    limit: Number(els.limit.value || 40),
    sort: els.sort.value,
    includeReplies: els.inclReplies.checked ? 1 : 0,
    includeQuotes: els.inclQuotes.checked ? 1 : 0,
    preferReporters: els.preferReporters.checked ? 1 : 0,
    nocache: els.nocache.checked ? 1 : 0,
  };

  const u = new URL('/api/reactions', location.origin);
  Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,String(v)));
  els.btnSearch.disabled = true;
  els.results.innerHTML = `<div class="muted">Loading…</div>`;
  try {
    const r = await fetch(u.toString(), { credentials:'omit' });
    const data = await r.json();
    latest = Array.isArray(data.items) ? data.items : [];
    renderResults(latest);
    renderPills(params, latest.length);
  } catch (e) {
    els.results.innerHTML = `<div class="muted">Error: ${e?.message||e}</div>`;
  } finally {
    els.btnSearch.disabled = false;
  }
}

els.btnSearch.addEventListener('click', runSearch);
els.copyHtml.addEventListener('click', ()=> {
  const html = buildPrestoHTML();
  if (!html) return alert('Select at least one post.');
  copy(html);
});
els.copyLinks.addEventListener('click', ()=>{
  const items = selectionInCurrentOrder();
  if (!items.length) return alert('Select at least one post.');
  copy(items.map(x=>x.url).join("\n"));
});
els.priorityOnly.addEventListener('change', renderSelection);

// first load
runSearch();
</script>
</body>
</html>
