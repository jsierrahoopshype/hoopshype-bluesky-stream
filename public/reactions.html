<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bluesky Reactions Builder</title>
  <style>
    :root{--accent:#0a66c2}
    body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    h1{font-size:22px;margin:0 0 20px}
    .panel{background:#fff;border:1px solid #e6e6e6;border-radius:10px;padding:16px;margin:0 0 16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{display:flex;flex-direction:column;gap:6px;min-width:220px;flex:1}
    label{font-size:12px;color:#555}
    input[type="text"],input[type="number"],select{
      padding:8px 10px;border:1px solid #d8d8d8;border-radius:6px;font:inherit
    }
    .checks{display:flex;gap:16px;align-items:center;margin-top:4px}
    .btn{appearance:none;border:none;border-radius:8px;padding:9px 14px;font-weight:600;background:var(--accent);color:#fff;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:default}
    .muted{color:#777;font-size:12px}
    .results-h{display:flex;justify-content:space-between;align-items:center;margin:8px 0 12px}
    .cards{display:flex;flex-direction:column;gap:12px}
    .card{background:#fff;border:1px solid #eee;border-radius:10px;padding:12px}
    .name{font-weight:700}
    .handle{color:#666;text-decoration:none;margin-left:6px}
    .time{color:#999;margin-left:6px}
    .text{line-height:1.35}
    .media img{max-width:100%;height:auto;border-radius:6px;display:block;margin-top:8px}
    .counts{margin-top:6px;font-size:12px;color:#666}
    .copyleft{width:100%;height:200px;padding:10px;border:1px solid #ddd;border-radius:8px;font-family:ui-monospace,Menlo,Consolas,monospace}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{background:#eef5ff;border:1px solid #c9defa;color:#174ea6;border-radius:999px;padding:4px 8px;font-size:12px}
    .embed-wrap{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Bluesky Reactions Builder</h1>

    <div class="panel">
      <div class="row">
        <div class="col" style="min-width:360px">
          <label>Search (e.g., <i>Luka Doncic trade</i>)</label>
          <input id="q" type="text" placeholder="Type keywords‚Ä¶" value="NBA" />
        </div>
        <div class="col">
          <label>Lookback (hours)</label>
          <input id="hours" type="number" value="6" min="1" />
        </div>
        <div class="col">
          <label>Min reposts</label>
          <input id="minReposts" type="number" value="10" min="0" />
        </div>
        <div class="col">
          <label>Min likes</label>
          <input id="minLikes" type="number" value="0" min="0" />
        </div>
        <div class="col">
          <label>Limit</label>
          <input id="limit" type="number" value="40" min="1" />
        </div>
        <div class="col">
          <label>Sort by</label>
          <select id="sort">
            <option value="reposts">Reposts (desc)</option>
            <option value="likes">Likes (desc)</option>
            <option value="total">Likes + Reposts (desc)</option>
            <option value="time">Newest first</option>
          </select>
        </div>
      </div>

      <div class="checks">
        <label><input id="inclReplies" type="checkbox" /> Include replies</label>
        <label><input id="inclQuotes" type="checkbox" /> Include quotes</label>
        <button class="btn" id="searchBtn">Search</button>
        <button class="btn" id="embedBtn" style="background:#4a4a4a">Build Presto Embed</button>
      </div>
    </div>

    <div class="panel">
      <div class="results-h">
        <div class="toolbar">
          <span class="pill" id="pill-q">q: ‚Äî</span>
          <span class="pill" id="pill-window">window: ‚Äî</span>
          <span class="pill" id="pill-min">min reposts: ‚Äî</span>
          <span class="pill" id="pill-count">0 results</span>
        </div>
      </div>
      <div id="cards" class="cards"></div>

      <div id="embedWrap" class="embed-wrap" style="margin-top:16px">
        <label>Presto embed HTML</label>
        <textarea id="embedBox" class="copyleft" readonly></textarea>
      </div>
    </div>

    <p class="muted">Tip: if a search returns empty, lower thresholds or add <code>&nocache=1</code> to bypass the 3-minute API cache.</p>
  </div>

  <script>
    // ---------- Small helpers ----------
    const $ = (s) => document.querySelector(s);
    const els = {
      q: $('#q'),
      hours: $('#hours'),
      minReposts: $('#minReposts'),
      minLikes: $('#minLikes'),
      limit: $('#limit'),
      sort: $('#sort'),
      inclReplies: $('#inclReplies'),
      inclQuotes: $('#inclQuotes'),
      searchBtn: $('#searchBtn'),
      embedBtn: $('#embedBtn'),
      cards: $('#cards'),
      pillQ: $('#pill-q'),
      pillWindow: $('#pill-window'),
      pillMin: $('#pill-min'),
      pillCount: $('#pill-count'),
      embedWrap: $('#embedWrap'),
      embedBox: $('#embedBox'),
    };

    function htmlEscape(s=''){ return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    async function fetchReactions(params){
      const qs = new URLSearchParams(params).toString();
      const url = `/api/reactions?${qs}`;
      const r = await fetch(url, {credentials: 'omit'});
      const data = await r.json().catch(() => ({}));
      return Array.isArray(data.items) ? data.items : [];
    }

    function render(items){
      els.cards.innerHTML = items.map(p => {
        const prof = p.url ? new URL(p.url) : null;
        const parts = prof ? prof.pathname.split('/').filter(Boolean) : [];
        const did = parts[1] ? parts[1] : '';
        const profileUrl = prof ? `${prof.origin}/profile/${did}` : '#';
        const avatar = p.authorAvatar || '';
        const media = p.mediaUrl ? `<div class="media"><img src="${p.mediaUrl}" loading="lazy" alt=""></div>` : '';
        return `
          <article class="card">
            <div class="name">
              ${htmlEscape(p.authorDisplay || '')}
              <a class="handle" href="${profileUrl}" target="_blank" rel="noopener">@${htmlEscape(p.authorHandle || '')}</a>
              <span class="time"> ‚Ä¢ ${htmlEscape(p.tsLocal || '')}</span>
            </div>
            <div class="text">${p.html || ''}</div>
            ${media}
            <div class="counts">‚ù§Ô∏è ${p.likeCount ?? 0} ‚Ä¢ üîÅ ${p.repostCount ?? 0}</div>
          </article>`;
      }).join('');
    }

    function buildEmbedHTML(items, params){
      const { q, hours, minReposts, minLikes, limit, sort, inclReplies, inclQuotes } = params;
      const code = `
<!-- Bluesky Reactions (client render) -->
<div id="bsky-reactions" data-q="${htmlEscape(q)}" data-hours="${hours}" data-minreposts="${minReposts}"
  data-minlikes="${minLikes}" data-limit="${limit}" data-sort="${htmlEscape(sort)}"
  data-inclreplies="${inclReplies ? 1 : 0}" data-inclquotes="${inclQuotes ? 1 : 0}">Loading‚Ä¶</div>
<script>
(async()=>{const e=document.getElementById('bsky-reactions');const g=e.dataset;const u='/api/reactions?'+new URLSearchParams({
  q:g.q,hours:g.hours,minReposts:g.minreposts,minLikes:g.minlikes,limit:g.limit,sort:g.sort,
  includeReplies:g.inclreplies,includeQuotes:g.inclquotes}).toString();
const r=await fetch(u);const d=await r.json();const a=Array.isArray(d.items)?d.items:[];
e.innerHTML=(a.length?'<ul>'+a.map(p=>'<li><a href=\"'+p.url+'\" rel=\"nofollow\" target=\"_blank\">'+(p.authorDisplay||'')+'</a>: '+(p.text||'')+'</li>').join('')+'</ul>':'<p>No results.</p>');})();</script>`;
      return code.trim();
    }

    async function runSearch(){
      const params = {
        q: els.q.value.trim(),
        hours: Number(els.hours.value || 6),
        minReposts: Number(els.minReposts.value || 0),
        minLikes: Number(els.minLikes.value || 0),
        limit: Number(els.limit.value || 40),
        sort: els.sort.value,
        includeReplies: els.inclReplies.checked ? 1 : 0,
        includeQuotes: els.inclQuotes.checked ? 1 : 0,
        nocache: 1   // always bypass cache in the builder UI
      };

      els.pillQ.textContent = `q: ${params.q || '‚Äî'}`;
      els.pillWindow.textContent = `window: ${params.hours}h`;
      els.pillMin.textContent = `min reposts: ${params.minReposts}`;

      els.searchBtn.disabled = true;
      const items = await fetchReactions(params).catch(()=>[]);
      els.searchBtn.disabled = false;

      els.pillCount.textContent = `${items.length} results`;
      render(items);

      // prepare embed block
      const code = buildEmbedHTML(items, params);
      els.embedBox.value = code;
      els.embedWrap.style.display = 'block';
      els.embedBox.focus();
      els.embedBox.select();
    }

    function init(){
      els.searchBtn.addEventListener('click', runSearch);
      els.embedBtn.addEventListener('click', () => els.embedWrap.style.display='block');
      // first load
      runSearch();
    }
    init();
  </script>
</body>
</html>
